<!DOCTYPE html>
<html lang="no">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Relex Focus – produkter å se på</title>
    <style>
      :root {
        --bg: #0f172a;
        --panel: #111827;
        --ink: #e5e7eb;
        --muted: #9ca3af;
        --accent: #60a5fa;
        --warn: #f59e0b;
        --bad: #ef4444;
        --good: #22c55e;
        --grid: #223358;
        --chip: #1f2937;
      }

      html,
      body {
        background: var(--bg);
        color: var(--ink);
        font: 14px/1.4 system-ui, Segoe UI, Roboto, Arial, sans-serif;
        margin: 0;
      }

      header {
        padding: 16px 20px;
        border-bottom: 1px solid #1f2937;
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }

      h1 {
        font-size: 18px;
        margin: 0 12px 0 0;
      }

      .drop {
        border: 1px dashed #334155;
        border-radius: 12px;
        padding: 16px;
        background: #0b1222;
        cursor: pointer;
      }

      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .card {
        background: var(--panel);
        border: 1px solid #1f2937;
        border-radius: 12px;
        padding: 12px;
      }

      label {
        font-size: 12px;
        color: var(--muted);
      }

      input,
      select,
      button {
        font: inherit;
      }

      input,
      select {
        background: #0b1222;
        border: 1px solid #1f2937;
        color: var(--ink);
        border-radius: 10px;
        padding: 8px 10px;
      }

      input[type='number'] {
        width: 110px;
      }

      .pill {
        background: var(--chip);
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid #1f2937;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 8px 10px;
        border-bottom: 1px solid #1f2937;
        text-align: left;
        vertical-align: middle;
      }

      th {
        position: sticky;
        top: 0;
        background: #0b1222;
        border-bottom: 1px solid #223358;
        font-weight: 600;
      }

      .muted {
        color: var(--muted);
      }

      .kpi {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
      }

      .kpi .card {
        min-width: 160px;
      }

      .tag {
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid #2a364f;
      }

      .tag.bad {
        background: #2a1420;
        border-color: #5f2139;
        color: #ffb4c8;
      }

      .tag.warn {
        background: #2a2313;
        border-color: #4f4221;
        color: #ffd38a;
      }

      .tag.good {
        background: #102517;
        border-color: #1e4d33;
        color: #b7ffcd;
      }

      .btn {
        background: #0b5;
        padding: 8px 12px;
        border-radius: 10px;
        border: 0;
        color: #fff;
        cursor: pointer;
      }

      .btn.secondary {
        background: #334155;
        color: #e5e7eb;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .right {
        margin-left: auto;
      }

      .hint {
        font-size: 12px;
        color: var(--muted);
      }

      .fit {
        max-width: 100%;
        overflow: auto;
      }

      details {
        border: 1px solid #1f2937;
        background: #0b1222;
        border-radius: 12px;
        padding: 10px;
      }

      details[open] {
        outline: 1px solid #223358;
      }

      .help {
        margin-top: 12px;
      }

      /* Pivot */
      .pivotHeader {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 14px;
        margin-bottom: 6px;
      }

      .chipFilter {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .chipBtn {
        background: #0b1222;
        border: 1px solid #1f2937;
        border-radius: 999px;
        padding: 6px 10px;
      }

      .chipBtn strong {
        font-weight: 600;
      }

      .clickable {
        cursor: pointer;
      }

      .clickable:hover {
        background: #0b1222;
      }
    </style>
  </head>

  <body>
    <header class="row">
      <h1>Relex Focus</h1>
      <div id="drop" class="drop" tabindex="0" title="Klikk for å velge fil eller dra-og-slipp hit">
        Dra-og-slipp Relex-eksport (CSV eller HTML) hit – eller klikk
        <input id="file" type="file" accept=".csv,.html,.htm,text/csv,text/html" style="display: none" />
      </div>

      <div class="card">
        <div class="row" style="gap: 8px">
          <div>
            <label>Maks. hylle-servicegrad (%)</label><br />
            <input id="maxAvail" type="number" step="0.1" value="95" />
          </div>
          <div>
            <label>Min. salgsverdi (kr)</label><br />
            <input id="minSales" type="number" step="1000" value="50000" />
          </div>
          <div>
            <label>ABC filter</label><br />
            <select id="abc">
              <option value="">Alle</option>
              <option>A</option>
              <option>B</option>
              <option>C</option>
              <option>#</option>
            </select>
          </div>
          <div>
            <label>XYZ filter</label><br />
            <select id="xyz">
              <option value="">Alle</option>
              <option>X</option>
              <option>Y</option>
              <option>Z</option>
              <option>#</option>
            </select>
          </div>
          <div>
            <label>Søk (navn/kode/lev.)</label><br />
            <input id="q" type="search" placeholder="f.eks. H7, kabel, 7400…, EXIDE, SE1-7270150" />
          </div>
          <div>
            <label>Kriterier</label><br />
            <select id="mode">
              <option value="both">Begge (lav hylle OG høy salg)</option>
              <option value="either">Minst ett (lav hylle ELLER høy salg)</option>
              <option value="hylle">Kun lav hylle</option>
              <option value="salg">Kun høy salg</option>
            </select>
          </div>

          <!-- NYTT: Lokasjonsfilter -->
          <div>
            <label>Lokasjon (fra Lev.kode)</label><br />
            <select id="region">
              <option value="">Alle</option>
              <option value="NO2">Vestby (NO2-)</option>
              <option value="SE1">Örebro (SE1-)</option>
              <option value="OTHER">Andre/ukjent</option>
            </select>
          </div>

          <div class="right">
            <label>&nbsp;</label><br />
            <button id="btnExport" class="btn" disabled>Eksporter utsnitt (CSV)</button>
          </div>
        </div>
      </div>
    </header>

    <main style="padding: 12px 16px">
      <!-- KPI-er -->
      <div class="kpi">
        <div class="card">
          <div class="muted">Rader (totalt)</div>
          <div id="kTotal" style="font-size: 20px">–</div>
        </div>
        <div class="card">
          <div class="muted">Rader (filtrert)</div>
          <div id="kShown" style="font-size: 20px">–</div>
        </div>
        <div class="card">
          <div class="muted">Snitt servicegrad (filtrert)</div>
          <div id="kAvgA" style="font-size: 20px">–</div>
        </div>
        <div class="card">
          <div class="muted">Snitt lageromløp (filtrert)</div>
          <div id="kAvgT" style="font-size: 20px">–</div>
        </div>
        <div class="card">
          <div class="muted">Sum salgsverdi (filtrert)</div>
          <div id="kSumS" style="font-size: 20px">–</div>
        </div>
      </div>

      <!-- Leverandør-pivot -->
      <div class="pivotHeader">
        <strong>Leverandører (pivot)</strong>
        <select id="pivotScope">
          <option value="filtered">Pivotgrunnlag: Kun filtrerte</option>
          <option value="all">Pivotgrunnlag: Alle produkter</option>
        </select>
        <input id="pivotQ" type="search" placeholder="Søk leverandørnavn / -kode" />
        <div class="chipFilter" id="supplierChip" hidden>
          <span class="chipBtn"><strong>Filter:</strong> <span id="supplierLabel"></span></span>
          <button id="clearSupplier" class="btn secondary" type="button">Fjern filter</button>
        </div>
      </div>
      <div class="card fit" id="pivotCard">
        <table id="tblPivot">
          <thead>
            <tr>
              <th class="clickable" data-k="SuppName">Leverandør</th>
              <th class="clickable" data-k="SuppCode">Lev.kode</th>
              <th class="clickable" data-k="count">Produkter</th>
              <th class="clickable" data-k="avgAvail">Snitt hylle-%</th>
              <th class="clickable" data-k="avgTurns">Snitt omløp</th>
              <th class="clickable" data-k="sumSales">Sum salg</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="hint">Klikk på en leverandør for å vise produktene under.</div>
      </div>

      <!-- Ingen treff / kolonnekart -->
      <details class="help" id="help" hidden>
        <summary>Ingen treff? Klikk for tips / kolonnekart</summary>
        <div style="margin-top: 8px">
          <p class="muted">
            Hvis filtrene er for strenge, prøv f.eks. <b>Maks hylle=100</b> og <b>Min salg=0</b>, sett <b>Kriterier=Minst ett</b>. Hvis det fortsatt er 0 rader – velg kolonner manuelt under:
          </p>
          <div class="card">
            <div class="row" style="gap: 10px">
              <div><label>Leverandørnavn</label><br /><select id="mapSuppName"></select></div>
              <div><label>Leverandørkode</label><br /><select id="mapSuppCode"></select></div>
              <div><label>Hylle% (kolonne)</label><br /><select id="mapAvail"></select></div>
              <div><label>Salgsverdi (kolonne)</label><br /><select id="mapSales"></select></div>
              <div><label>Lageromløp</label><br /><select id="mapTurns"></select></div>
              <div><label>Beholdningsverdi</label><br /><select id="mapStock"></select></div>
              <div><label>ABC</label><br /><select id="mapABC"></select></div>
              <div><label>XYZ</label><br /><select id="mapXYZ"></select></div>
            </div>
            <div class="muted" style="margin-top: 6px">Valget lagres lokalt (nettleser) per filtype, så du slipper å velge neste gang.</div>
            <div style="align-self: end; display: flex; gap: 8px">
              <button class="btn" id="saveMap">Lagre kart</button>
              <button class="btn secondary" id="resetMap">Nullstill kart</button>
            </div>
          </div>
        </div>
      </details>

      <!-- Produkt-tabell -->
      <div class="card fit" style="margin-top: 12px">
        <table id="tbl">
          <thead>
            <tr></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="hint">Tips: Klikk på kolonne-overskrifter for å sortere.</div>
      </div>
    </main>

    <script>
      /* ---------- Norsk tall ---------- */
      const num = s => {
        if (s == null) return null;
        if (typeof s === 'number') return s;
        s = String(s).trim();
        if (!s) return null;
        s = s
          .replace(/\u00A0/g, ' ')
          .replace(/ kr/gi, '')
          .replace(/kr/gi, '')
          .replace(/ /g, '');
        if (/%$/.test(s)) {
          s = s.replace('%', '').replace(',', '.');
          const v = parseFloat(s);
          return Number.isFinite(v) ? v : null;
        }
        s = s.replace(',', '.');
        const v = Number(s);
        return Number.isFinite(v) ? v : null;
      };
      // prosenter: CSV=brøk (<=1) → gang med 100, HTML=allerede %
      const pct = x => {
        const v = num(x);
        return v == null ? null : v <= 1 ? v * 100 : v;
      };
      const fmtNo = n => (n == null ? '–' : n.toLocaleString('no-NO'));
      const fmtKr = n => (n == null ? '–' : Math.round(n).toLocaleString('no-NO') + ' kr');

      /* ---------- Parse ---------- */
      async function readFile(f) {
        // CSV: prøv UTF-8 først, fall tilbake til Windows-1252 hvis vi ser �
        if (/\.(csv)$/i.test(f.name)) {
          const buf = await f.arrayBuffer();
          let text = new TextDecoder('utf-8', { fatal: false }).decode(buf);
          if (/\uFFFD/.test(text)) text = new TextDecoder('windows-1252').decode(buf);
          return parseCSV(text);
        }
        const text = await f.text();
        if (/<table/i.test(text)) return parseHTMLTable(text);
        return parseCSV(text);
      }
      function parseCSV(text) {
        const sep = text.indexOf(';') > -1 ? ';' : ',';
        let lines = text
          .replace(/^\uFEFF/, '')
          .split(/\r?\n/)
          .map(l => l.trimEnd())
          .filter(l => l.length);
        if (/^Periodens startdato\s*;.*;Periodens sluttdato\s*;/.test(lines[0])) lines.shift();
        let headers = lines
          .shift()
          .split(sep)
          .map(h => h.trim());
        if (!headers[0]) headers[0] = 'Produktnavn';
        let rows = lines.map(line => {
          const cells = line.split(sep);
          const o = {};
          headers.forEach((h, i) => (o[h] = (cells[i] ?? '').trim()));
          return o;
        });
        rows = rows.filter(r => (r['Produktnavn'] || '').toLowerCase() !== 'totalt' && (r['Produktkode'] || '').trim() !== '#');
        return { headers, rows, kind: 'csv' };
      }
      function parseHTMLTable(html) {
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const t = doc.querySelector('table');
        const headers = [...t.querySelectorAll('thead tr th, thead tr td')].map(th => th.textContent.trim());
        const rows = [...t.querySelectorAll('tbody tr')].map(tr => {
          const o = {};
          [...tr.children].forEach((td, i) => (o[headers[i] || 'col' + i] = td.textContent.trim()));
          return o;
        });
        return { headers, rows, kind: 'html' };
      }

      /* ---------- App state ---------- */
      let data = { headers: [], rows: [], kind: '' };
      let shown = [];
      let sortKey = null,
        sortDir = 1;
      let supplierFilter = null; // {SuppName, SuppCode}

      /* ---------- Autodeteksjon + fallback ---------- */
      const wantedCols = [
        { k: 'SupplierName', m: /(Leverand.{0,2}r\s*navn|Leverant.{0,2}rs?namn|Supplier.*name|Vendor.*name)/i },
        { k: 'SupplierCode', m: /(Leverand.{0,2}r\s*kode|Leverant.{0,2}r.*(kod|nr|nummer)|Supplier.*code|Vendor.*(code|id))/i },
        { k: 'Produktnavn', m: /(^|\s)Produktnavn|Produktnamn|Product name/i },
        { k: 'Produktkode', m: /^Produktkode|Product code|SKU/i },
        { k: 'Hylle%', m: /Hyll(e|es).*service|Hylleservicegrad.*(første|foerste)|Availability.*first/i },
        { k: 'Lageromløp', m: /Lageroml|oml[øo]pshast|Turnover|Rotation/i },
        { k: 'Beholdningsverdi', m: /Beholdningens snittverdi|Stock.*value|Inventory.*value/i },
        { k: 'Salg verdi', m: /^Salg.*\(verdi\)|Sales.*value/i },
        { k: 'ABC', m: /^ABC-?klassifisering/i },
        { k: 'XYZ', m: /^XYZ-?klasse/i }
      ];
      let manualMap = JSON.parse(localStorage.getItem('relexMap') || '{}');

      function buildMap(headers) {
        const map = {};
        for (const col of wantedCols) {
          const saved = manualMap[col.k];
          if (saved && headers.includes(saved) && col.m.test(saved)) {
            map[col.k] = saved;
            continue;
          }
          const hit = headers.find(h => col.m.test(h));
          map[col.k] = hit || null;
        }
        return map;
      }

      function mapRowFactory(headers) {
        const cols = buildMap(headers);

        // vis kolonnekart hvis vi mangler hylle/salg ELLER leverandør-kolonner
        const criticalMissing = !cols['Hylle%'] || !cols['Salg verdi'] || !cols['SupplierName'] || !cols['SupplierCode'];
        const helpEl = document.getElementById('help');
        if (helpEl) {
          helpEl.hidden = !criticalMissing;
          if (criticalMissing) {
            populateMapper(headers, cols);
            helpEl.open = true;
          }
        }

        return function mapRow(row) {
          const sNameRaw = (row[cols['SupplierName']] ?? '').trim();
          const sCodeRaw = (row[cols['SupplierCode']] ?? '').trim();
          const sName = sNameRaw === '#' ? '' : sNameRaw;
          const sCode = sCodeRaw === '#' ? '' : sCodeRaw;

          const codeUC = (sCode || '').toUpperCase();
          const Region = codeUC.startsWith('NO2-') ? 'NO2' : codeUC.startsWith('SE1-') ? 'SE1' : 'OTHER';

          return {
            SuppName: sName,
            SuppCode: sCode,
            Region,
            Navn: row[cols['Produktnavn']] ?? '',
            Kode: row[cols['Produktkode']] ?? '',
            Avail: pct(row[cols['Hylle%']]), // CSV-brøk → %
            Turns: num(row[cols['Lageromløp']]),
            StockVal: num(row[cols['Beholdningsverdi']]),
            Sales: num(row[cols['Salg verdi']]),
            ABC: (row[cols['ABC']] ?? '').trim(),
            XYZ: (row[cols['XYZ']] ?? '').trim(),
            _raw: row
          };
        };
      }

      /* ---------- Filter ---------- */
      function applyFilters() {
        const maxAvail = Number(document.getElementById('maxAvail').value || 100);
        const minSales = Number(document.getElementById('minSales').value || 0);
        const abc = document.getElementById('abc').value;
        const xyz = document.getElementById('xyz').value;
        const q = (document.getElementById('q').value || '').trim().toLowerCase();
        const mode = document.getElementById('mode').value;
        const regionSel = document.getElementById('region').value; // "", "NO2", "SE1", "OTHER"

        const mapRow = mapRowFactory(data.headers);
        const mapped = data.rows.map(mapRow);

        shown = mapped.filter(r => {
          const hasAvail = Number.isFinite(r.Avail);
          const hasSales = Number.isFinite(r.Sales);
          const condAvail = hasAvail ? r.Avail <= maxAvail : false;
          const condSales = hasSales ? r.Sales >= minSales : false;

          let passes = false;
          if (mode === 'both') passes = condAvail && condSales;
          if (mode === 'either') passes = condAvail || condSales;
          if (mode === 'hylle') passes = condAvail;
          if (mode === 'salg') passes = condSales;

          const okABC = !abc || r.ABC === abc;
          const okXYZ = !xyz || r.XYZ === xyz;
          const okQ = !q || r.Navn.toLowerCase().includes(q) || r.Kode.toLowerCase().includes(q) || (r.SuppName || '').toLowerCase().includes(q) || (r.SuppCode || '').toLowerCase().includes(q);
          const okSupplier = !supplierFilter || (r.SuppName === supplierFilter.SuppName && r.SuppCode === supplierFilter.SuppCode);
          const okRegion = !regionSel || (regionSel === 'OTHER' ? r.Region === 'OTHER' : r.Region === regionSel);

          return passes && okABC && okXYZ && okQ && okSupplier && okRegion;
        });

        const key = sortKey || 'Avail';
        shown.sort((a, b) => {
          const av = a[key] ?? -Infinity,
            bv = b[key] ?? -Infinity;
          if (av < bv) return -1 * sortDir;
          if (av > bv) return 1 * sortDir;
          if (a.Sales > b.Sales) return -1;
          if (a.Sales < b.Sales) return 1;
          return 0;
        });

        render();
        renderPivot(mapped); // bygg pivot hver gang, men la den også respektere region (se funksjonen)
      }

      /* ---------- Mapper UI ---------- */
      function populateMapper(headers, cols) {
        const ids = [
          ['mapSuppName', 'SupplierName'],
          ['mapSuppCode', 'SupplierCode'],
          ['mapAvail', 'Hylle%'],
          ['mapSales', 'Salg verdi'],
          ['mapTurns', 'Lageromløp'],
          ['mapStock', 'Beholdningsverdi'],
          ['mapABC', 'ABC'],
          ['mapXYZ', 'XYZ']
        ];
        ids.forEach(([id, key]) => {
          const sel = document.getElementById(id);
          if (!sel) return;
          sel.innerHTML = headers.map(h => `<option ${cols[key] === h ? 'selected' : ''}>${h}</option>`).join('');
        });
      }
      document.getElementById('saveMap')?.addEventListener('click', () => {
        manualMap = {
          SupplierName: document.getElementById('mapSuppName')?.value,
          SupplierCode: document.getElementById('mapSuppCode')?.value,
          'Hylle%': document.getElementById('mapAvail')?.value,
          'Salg verdi': document.getElementById('mapSales')?.value,
          Lageromløp: document.getElementById('mapTurns')?.value,
          Beholdningsverdi: document.getElementById('mapStock')?.value,
          ABC: document.getElementById('mapABC')?.value,
          XYZ: document.getElementById('mapXYZ')?.value
        };
        localStorage.setItem('relexMap', JSON.stringify(manualMap));
        applyFilters();
      });
      document.getElementById('resetMap')?.addEventListener('click', () => {
        manualMap = {};
        localStorage.removeItem('relexMap');
        const cols = buildMap(data.headers);
        populateMapper(data.headers, cols);
        applyFilters();
      });

      /* ---------- Render produkter ---------- */
      function render() {
        document.getElementById('kTotal').textContent = fmtNo(data.rows.length);
        document.getElementById('kShown').textContent = fmtNo(shown.length);
        const avgA = shown.length ? shown.reduce((s, r) => s + (r.Avail ?? 0), 0) / shown.length : null;
        const turnsVals = shown.map(r => r.Turns).filter(Number.isFinite);
        const avgT = turnsVals.length ? turnsVals.reduce((a, b) => a + b, 0) / turnsVals.length : null;
        const sumS = shown.length ? shown.reduce((s, r) => s + (r.Sales ?? 0), 0) : null;
        document.getElementById('kAvgA').textContent = avgA == null ? '–' : avgA.toFixed(2) + ' %';
        document.getElementById('kAvgT').textContent = avgT == null ? '–' : avgT.toFixed(2);
        document.getElementById('kSumS').textContent = fmtKr(sumS);

        const thead = document.querySelector('#tbl thead tr');
        const tbody = document.querySelector('#tbl tbody');
        thead.innerHTML = '';
        tbody.innerHTML = '';

        const cols = [
          { h: 'Leverandør', k: 'SuppName' },
          { h: 'Lev.kode', k: 'SuppCode' },
          { h: 'Produkt', k: 'Navn' },
          { h: 'Kode', k: 'Kode' },
          { h: 'Hylle-servicegrad %', k: 'Avail' },
          { h: 'Salgsverdi', k: 'Sales' },
          { h: 'Lageromløp', k: 'Turns' },
          { h: 'Beholdningsverdi', k: 'StockVal' },
          { h: 'ABC', k: 'ABC' },
          { h: 'XYZ', k: 'XYZ' }
        ];
        for (const c of cols) {
          const th = document.createElement('th');
          th.textContent = c.h;
          th.className = 'clickable';
          th.onclick = () => {
            sortKey = c.k;
            sortDir = sortDir === 1 ? -1 : 1;
            render();
          };
          thead.appendChild(th);
        }
        for (const r of shown) {
          const tr = document.createElement('tr');
          const sev = r.Avail == null ? null : r.Avail < 90 ? 'bad' : r.Avail < 95 ? 'warn' : 'good';
          const sevTag = sev ? `<span class="tag ${sev}">${r.Avail.toFixed(2)} %</span>` : '<span class="muted">–</span>';
          tr.innerHTML = `
      <td>${r.SuppName || '<span class="muted">–</span>'}</td>
      <td class="muted">${r.SuppCode || ''}</td>
      <td>${r.Navn || '<span class="muted">–</span>'}</td>
      <td class="muted">${r.Kode || ''}</td>
      <td>${sevTag}</td>
      <td>${fmtKr(r.Sales)}</td>
      <td>${r.Turns == null ? '–' : r.Turns.toFixed(2)}</td>
      <td>${fmtKr(r.StockVal)}</td>
      <td>${r.ABC || '<span class="muted">–</span>'}</td>
      <td>${r.XYZ || '<span class="muted">–</span>'}</td>
    `;
          tbody.appendChild(tr);
        }

        document.getElementById('btnExport').disabled = shown.length === 0;

        // chip visning (robust)
        const chip = document.getElementById('supplierChip');
        const lab = document.getElementById('supplierLabel');
        if (chip && lab) {
          if (supplierFilter) {
            lab.textContent = `${supplierFilter.SuppName} (${supplierFilter.SuppCode})`;
            chip.hidden = false;
            chip.style.display = 'flex';      // ← tving visning
          } else {
            lab.textContent = '';
            chip.hidden = true;
            chip.style.display = 'none';      // ← tving skjuling
          }
        }
      } // <-- Add this closing brace to properly end the render() function

      /* ---------- Leverandør-pivot ---------- */
      let pivotSortKey = 'avgAvail',
        pivotSortDir = 1;

      function renderPivot(mappedAll) {
        const regionSel = document.getElementById('region').value;
        const scope = document.getElementById('pivotScope').value;

        // grunnlag: 'filtered' = shown (allerede regionfiltrert), 'all' = alt men regionfiltrert her
        const okRegion = r => !regionSel || (regionSel === 'OTHER' ? r.Region === 'OTHER' : r.Region === regionSel);
        const base = scope === 'filtered' ? shown : mappedAll.filter(okRegion);

        const rows = base.filter(r => r.SuppName || r.SuppCode);

        // aggreger
        const map = new Map();
        for (const r of rows) {
          const key = `${r.SuppName}|||${r.SuppCode}`;
          if (!map.has(key)) map.set(key, { SuppName: r.SuppName, SuppCode: r.SuppCode, sumSales: 0, sumAvail: 0, cntAvail: 0, sumTurns: 0, cntTurns: 0, count: 0 });
          const g = map.get(key);
          g.count++;
          if (Number.isFinite(r.Sales)) g.sumSales += r.Sales;
          if (Number.isFinite(r.Avail)) {
            g.sumAvail += r.Avail;
            g.cntAvail++;
          }
          if (Number.isFinite(r.Turns)) {
            g.sumTurns += r.Turns;
            g.cntTurns++;
          }
        }
        let pivot = [...map.values()].map(g => ({
          ...g,
          avgAvail: g.cntAvail ? g.sumAvail / g.cntAvail : null,
          avgTurns: g.cntTurns ? g.sumTurns / g.cntTurns : null
        }));

        // søk i pivot
        const pq = (document.getElementById('pivotQ').value || '').toLowerCase().trim();
        if (pq) {
          pivot = pivot.filter(g => (g.SuppName || '').toLowerCase().includes(pq) || (g.SuppCode || '').toLowerCase().includes(pq));
        }

        // sorter
        pivot.sort((a, b) => {
          const ak = a[pivotSortKey] == null ? -Infinity : a[pivotSortKey];
          const bk = b[pivotSortKey] == null ? -Infinity : b[pivotSortKey];
          if (ak < bk) return -1 * pivotSortDir;
          if (ak > bk) return 1 * pivotSortDir;
          // sekundært: sumSales desc
          if (a.sumSales > b.sumSales) return -1;
          if (a.sumSales < b.sumSales) return 1;
          return 0;
        });

        // render
        const tbody = document.querySelector('#tblPivot tbody');
        tbody.innerHTML = '';
        for (const g of pivot) {
          const tr = document.createElement('tr');
          tr.className = 'clickable';
          tr.onclick = () => {
            supplierFilter = { SuppName: g.SuppName, SuppCode: g.SuppCode };
            applyFilters();
          };
          tr.innerHTML = `
      <td>${g.SuppName || '<span class="muted">–</span>'}</td>
      <td class="muted">${g.SuppCode || ''}</td>
      <td>${fmtNo(g.count)}</td>
      <td>${g.avgAvail == null ? '–' : g.avgAvail.toFixed(2) + ' %'}</td>
      <td>${g.avgTurns == null ? '–' : g.avgTurns.toFixed(2)}</td>
      <td>${fmtKr(g.sumSales)}</td>
    `;
          tbody.appendChild(tr);
        }
      }

     // Sortering i pivot-header
      document.querySelectorAll('#tblPivot thead th.clickable').forEach(th => {
        th.addEventListener('click', () => {
          const k = th.getAttribute('data-k');
          if (pivotSortKey === k) pivotSortDir = pivotSortDir === 1 ? -1 : 1;
          else { pivotSortKey = k; pivotSortDir = 1; }
          renderPivot(data.rows.map(mapRowFactory(data.headers)));
        });
      });

      // Oppdater pivot ved søk / scope
      document.getElementById('pivotQ').addEventListener('input', () =>
        renderPivot(data.rows.map(mapRowFactory(data.headers)))
      );
      document.getElementById('pivotScope').addEventListener('input', () =>
        renderPivot(data.rows.map(mapRowFactory(data.headers)))
      );

      // --- Fjern leverandørfilter (robust + delegasjon) ---
      function clearSupplierFilter(e) {
          if (e) e.preventDefault();

          // 1) Nullstill valgt leverandør
          supplierFilter = null;

          // 2) Tøm søkefeltene
          const pq = document.getElementById('pivotQ'); if (pq) pq.value = '';
          const gq = document.getElementById('q'); if (gq) gq.value = '';

          // 3) Skjul chip umiddelbart (pluss i render())
          const chip = document.getElementById('supplierChip');
          const lab = document.getElementById('supplierLabel');
          if (lab) lab.textContent = '';
          if (chip) { chip.hidden = true; chip.style.display = 'none'; }

          // 4) Bygg alt på nytt
          applyFilters();
        }

        // Direkte lytter + delegasjon
        const clearBtn = document.getElementById('clearSupplier');
        if (clearBtn) clearBtn.addEventListener('click', clearSupplierFilter);
        document.addEventListener('click', (ev) => {
          const btn = ev.target.closest && ev.target.closest('#clearSupplier');
          if (btn) clearSupplierFilter(ev);
        });
  




      /* ---------- Export ---------- */
      function exportCSV() {
        const headers = ['Region', 'Leverandør', 'Lev.kode', 'Produkt', 'Kode', 'Hylle%', 'Salgsverdi', 'Lageromløp', 'Beholdningsverdi', 'ABC', 'XYZ'];
        const rows = shown.map(r => [
          r.Region,
          r.SuppName,
          r.SuppCode,
          r.Navn,
          r.Kode,
          r.Avail == null ? '' : r.Avail.toFixed(2),
          r.Sales == null ? '' : Math.round(r.Sales),
          r.Turns == null ? '' : r.Turns.toFixed(2),
          r.StockVal == null ? '' : Math.round(r.StockVal),
          r.ABC || '',
          r.XYZ || ''
        ]);
        const csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: 'relex-focus.csv' });
        a.click();
        URL.revokeObjectURL(a.href);
      }

      /* ---------- Wiring ---------- */
      const drop = document.getElementById('drop'),
        file = document.getElementById('file');
      drop.addEventListener('click', () => file.click());
      drop.addEventListener('dragover', e => {
        e.preventDefault();
        drop.style.borderColor = '#60a5fa';
      });
      drop.addEventListener('dragleave', () => (drop.style.borderColor = ''));
      drop.addEventListener('drop', async e => {
        e.preventDefault();
        drop.style.borderColor = '';
        if (!e.dataTransfer.files.length) return;
        await load(e.dataTransfer.files[0]);
      });
      file.addEventListener('change', async () => {
        if (file.files.length) await load(file.files[0]);
      });
      for (const id of ['maxAvail', 'minSales', 'abc', 'xyz', 'q', 'mode', 'region']) {
        document.getElementById(id).addEventListener('input', applyFilters);
      }
      document.getElementById('btnExport').addEventListener('click', exportCSV);

      async function load(f) {
          drop.innerHTML = `<span class="pill">Lastet: ${f.name}</span>`;
          const pq = document.getElementById('pivotQ'); if (pq) pq.value = '';
          const gq = document.getElementById('q'); if (gq) gq.value = '';
          data = await readFile(f);
          supplierFilter = null;
          applyFilters();
        }

    </script>
  </body>
</html>
