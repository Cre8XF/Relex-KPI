<!doctype html>
<html lang="no">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Relex Focus – produkter å se på</title>
    <style>
        :root {
            --bg: #0f172a;
            --panel: #111827;
            --ink: #e5e7eb;
            --muted: #9ca3af;
            --accent: #60a5fa;
            --warn: #f59e0b;
            --bad: #ef4444;
            --good: #22c55e;
            --grid: #223358;
            --chip: #1f2937
        }

        html,
        body {
            background: var(--bg);
            color: var(--ink);
            font: 14px/1.4 system-ui, Segoe UI, Roboto, Arial, sans-serif;
            margin: 0
        }

        header {
            padding: 16px 20px;
            border-bottom: 1px solid #1f2937;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap
        }

        h1 {
            font-size: 18px;
            margin: 0 12px 0 0
        }

        .drop {
            border: 1px dashed #334155;
            border-radius: 12px;
            padding: 16px;
            background: #0b1222;
            cursor: pointer
        }

        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap
        }

        .card {
            background: var(--panel);
            border: 1px solid #1f2937;
            border-radius: 12px;
            padding: 12px
        }

        label {
            font-size: 12px;
            color: var(--muted)
        }

        input,
        select {
            background: #0b1222;
            border: 1px solid #1f2937;
            color: var(--ink);
            border-radius: 10px;
            padding: 8px 10px
        }

        input[type="number"] {
            width: 110px
        }

        .pill {
            background: var(--chip);
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid #1f2937
        }

        table {
            width: 100%;
            border-collapse: collapse
        }

        th,
        td {
            padding: 8px 10px;
            border-bottom: 1px solid #1f2937;
            text-align: left;
            vertical-align: middle
        }

        th {
            position: sticky;
            top: 0;
            background: #0b1222;
            border-bottom: 1px solid #223358;
            font-weight: 600
        }

        .muted {
            color: var(--muted)
        }

        .kpi {
            display: flex;
            gap: 16px;
            flex-wrap: wrap
        }

        .kpi .card {
            min-width: 160px
        }

        .tag {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid #2a364f
        }

        .tag.bad {
            background: #2a1420;
            border-color: #5f2139;
            color: #ffb4c8
        }

        .tag.warn {
            background: #2a2313;
            border-color: #4f4221;
            color: #ffd38a
        }

        .tag.good {
            background: #102517;
            border-color: #1e4d33;
            color: #b7ffcd
        }

        .btn {
            background: #0b5;
            padding: 8px 12px;
            border-radius: 10px;
            border: 0;
            color: #fff;
            cursor: pointer
        }

        .btn:disabled {
            opacity: .5;
            cursor: not-allowed
        }

        .right {
            margin-left: auto
        }

        .hint {
            font-size: 12px;
            color: var(--muted)
        }

        .fit {
            max-width: 100%;
            overflow: auto
        }

        details {
            border: 1px solid #1f2937;
            background: #0b1222;
            border-radius: 12px;
            padding: 10px
        }

        details[open] {
            outline: 1px solid #223358
        }

        .help {
            margin-top: 12px
        }
    </style>
</head>

<body>
    <header class="row">
        <h1>Relex Focus</h1>
        <div id="drop" class="drop" tabindex="0" title="Klikk for å velge fil eller dra-og-slipp hit">
            Dra-og-slipp Relex-eksport (CSV eller HTML) hit – eller klikk
            <input id="file" type="file" accept=".csv,.html,.htm,text/csv,text/html" style="display:none">
        </div>
        <div class="card">
            <div class="row" style="gap:8px">
                <div>
                    <label>Maks. hylle-servicegrad (%)</label><br>
                    <input id="maxAvail" type="number" step="0.1" value="95">
                </div>
                <div>
                    <label>Min. salgsverdi (kr)</label><br>
                    <input id="minSales" type="number" step="1000" value="50000">
                </div>
                <div>
                    <label>ABC filter</label><br>
                    <select id="abc">
                        <option value="">Alle</option>
                        <option>A</option>
                        <option>B</option>
                        <option>C</option>
                        <option>#</option>
                    </select>
                </div>
                <div>
                    <label>XYZ filter</label><br>
                    <select id="xyz">
                        <option value="">Alle</option>
                        <option>X</option>
                        <option>Y</option>
                        <option>Z</option>
                        <option>#</option>
                    </select>
                </div>
                <div>
                    <label>Søk (navn/kode)</label><br>
                    <input id="q" type="search" placeholder="f.eks. H7, kabel, 7400…" />
                </div>
                <div>
                    <label>Kriterier</label><br>
                    <select id="mode">
                        <option value="both">Begge (lav hylle OG høy salg)</option>
                        <option value="either">Minst ett (lav hylle ELLER høy salg)</option>
                        <option value="hylle">Kun lav hylle</option>
                        <option value="salg">Kun høy salg</option>
                    </select>
                </div>
                <div class="right">
                    <label>&nbsp;</label><br>
                    <button id="btnExport" class="btn" disabled>Eksporter utsnitt (CSV)</button>
                </div>
            </div>
        </div>
    </header>

    <main style="padding:12px 16px">
        <div class="kpi">
            <div class="card">
                <div class="muted">Rader (totalt)</div>
                <div id="kTotal" style="font-size:20px">–</div>
            </div>
            <div class="card">
                <div class="muted">Rader (filtrert)</div>
                <div id="kShown" style="font-size:20px">–</div>
            </div>
            <div class="card">
                <div class="muted">Snitt servicegrad (filtrert)</div>
                <div id="kAvgA" style="font-size:20px">–</div>
            </div>
            <div class="card">
                <div class="muted">Sum salgsverdi (filtrert)</div>
                <div id="kSumS" style="font-size:20px">–</div>
            </div>
        </div>

        <details class="help" id="help" hidden>
            <summary>Ingen treff? Klikk for tips / kolonnekart</summary>
            <div style="margin-top:8px">
                <p class="muted">Hvis filtrene er for strenge, prøv f.eks. <b>Maks hylle=100</b> og <b>Min salg=0</b>,
                    sett <b>Kriterier=Minst ett</b>. Hvis det fortsatt er 0 rader – velg kolonner manuelt under:</p>
                <div class="card">
                    <div class="row" style="gap:10px">
                        <div><label>Hylle% (kolonne)</label><br><select id="mapAvail"></select></div>
                        <div><label>Salgsverdi (kolonne)</label><br><select id="mapSales"></select></div>
                        <div><label>Lageromløp</label><br><select id="mapTurns"></select></div>
                        <div><label>Beholdningsverdi</label><br><select id="mapStock"></select></div>
                        <div><label>ABC</label><br><select id="mapABC"></select></div>
                        <div><label>XYZ</label><br><select id="mapXYZ"></select></div>
                        <div style="align-self:end"><button class="btn" id="saveMap">Lagre kart</button></div>
                    </div>
                    <div class="muted" style="margin-top:6px">Valget lagres lokalt (nettleser) per filtype, så du
                        slipper å velge neste gang.</div>
                </div>
            </div>
        </details>

        <div class="card fit" style="margin-top:12px">
            <table id="tbl">
                <thead>
                    <tr></tr>
                </thead>
                <tbody></tbody>
            </table>
            <div class="hint">Tips: Klikk på kolonne-overskrifter for å sortere.</div>
        </div>
    </main>

    <script>
        /* ---------- Norsk tall ---------- */
       const num = s => {
            if (s == null) return null;
            if (typeof s === 'number') return s;
            s = String(s).trim();
            if (!s) return null;

            // fjern tusenskille
            s = s.replace(/\s/g, '').replace(/\u00A0/g, '');

            // prosent?
            if (/%$/.test(s)) {
                s = s.replace('%', '').replace(',', '.');
                const v = parseFloat(s);
                return Number.isFinite(v) ? v : null;
            }

            // valuta?
            s = s.replace('kr', '').trim();

            // generelt tall
            s = s.replace(',', '.');
            const v = Number(s);
            return Number.isFinite(v) ? v : null;
        };
        const pct = x => {
                const v = num(x);
                if (v == null) return null;
                // CSV: v <= 1 (brøk) → gang med 100. HTML: v > 1 (allerede %) → behold.
                return v <= 1 ? v * 100 : v;
            };


        const fmtNo = n => n == null ? '–' : n.toLocaleString('no-NO');
        const fmtKr = n => n == null ? '–' : (Math.round(n)).toLocaleString('no-NO') + ' kr';

        /* ---------- Parse ---------- */
        async function readFile(f) {
            const text = await f.text();
            if (/<table/i.test(text)) return parseHTMLTable(text);
            return parseCSV(text);
        }
        function parseCSV(text) {
                // Finn separator
                const sep = text.indexOf(';') > -1 ? ';' : ',';

                // Rens linjer
                let lines = text
                    .replace(/^\uFEFF/, '')          // fjern ev. BOM
                    .split(/\r?\n/)
                    .map(l => l.trimEnd())
                    .filter(l => l.length);

                // Hopp over metadatalinja ("Periodens startdato;...;Periodens sluttdato;...")
                if (/^Periodens startdato\s*;.*;Periodens sluttdato\s*;/.test(lines[0])) {
                    lines.shift();
                }

                // Header (fra Relex er første kolonne ofte uten navn → gi den et navn)
                let headers = lines.shift().split(sep).map(h => h.trim());
                if (!headers[0]) headers[0] = 'Produktnavn';

                // Bygg rader
                let rows = lines.map(line => {
                    const cells = line.split(sep);
                    const o = {};
                    headers.forEach((h, i) => o[h] = (cells[i] ?? '').trim());
                    return o;
                });

                // Fjern totalsrad og andre ikke-produkter
                rows = rows.filter(r => {
                    const navn = (r['Produktnavn'] || '').toLowerCase();
                    const kode = (r['Produktkode'] || '').trim();
                    return navn !== 'totalt' && kode !== '#';
                });

                return { headers, rows, kind: 'csv' };
            }

        function parseHTMLTable(html) {
            const doc = new DOMParser().parseFromString(html, 'text/html');
            const t = doc.querySelector('table');
            const headers = [...t.querySelectorAll('thead tr th, thead tr td')].map(th => th.textContent.trim());
            const rows = [...t.querySelectorAll('tbody tr')].map(tr => {
                const o = {};[...tr.children].forEach((td, i) => o[headers[i] || ('col' + i)] = td.textContent.trim()); return o;
            });
            return { headers, rows, kind: 'html' };
        }

        /* ---------- App state ---------- */
        let data = { headers: [], rows: [], kind: '' };
        let shown = [];
        let sortKey = null, sortDir = 1;

        /* ---------- Autodeteksjon + fallback ---------- */
        const wantedCols = [
            { k: 'Produktnavn', m: /(^|\s)Produktnavn|Produktnamn|Product name/i },
            { k: 'Produktkode', m: /^Produktkode|Product code|SKU/i },
            { k: 'Hylle%', m: /Hyll(e|es).*service|Hylleservicegrad.*(første|foerste)|Availability.*first/i },
            { k: 'Lageromløp', m: /Lageroml|oml[øo]pshast|Turnover|Rotation/i },
            { k: 'Beholdningsverdi', m: /Beholdningens snittverdi|Stock.*value|Inventory.*value/i },
            { k: 'Salg verdi', m: /^Salg.*\(verdi\)|Sales.*value/i },
            { k: 'ABC', m: /^ABC-?klassifisering/i },
            { k: 'XYZ', m: /^XYZ-?klasse/i },
        ];
        let manualMap = JSON.parse(localStorage.getItem('relexMap') || '{}');

        function buildMap(headers) {
            const map = {};
            for (const col of wantedCols) {
                // manual override?
                if (manualMap[col.k] && headers.includes(manualMap[col.k])) {
                    map[col.k] = manualMap[col.k]; continue;
                }
                const hit = headers.find(h => col.m.test(h));
                map[col.k] = hit || null;
            }
            return map;
        }

        /* ---------- Mapping + filter ---------- */
        function mapRowFactory(headers) {
            const cols = buildMap(headers);
            // vis hjelp dersom kritiske kolonner mangler
            const criticalMissing = !cols['Hylle%'] || !cols['Salg verdi'];
            document.getElementById('help').hidden = !criticalMissing;
            if (criticalMissing) populateMapper(headers, cols);

            return function mapRow(row) {
                return {
                    Navn: row[cols['Produktnavn']] ?? '',
                    Kode: row[cols['Produktkode']] ?? '',
                   Avail: pct(row[cols['Hylle%']]),
                    Turns: num(row[cols['Lageromløp']]),
                    StockVal: num(row[cols['Beholdningsverdi']]), // ← riktig nøkkel
                    Sales: num(row[cols['Salg verdi']]),
                    ABC: (row[cols['ABC']] ?? '').trim(),
                    XYZ: (row[cols['XYZ']] ?? '').trim(),
                    _raw: row
                };
            };
        }

        function applyFilters() {
            const maxAvail = Number(document.getElementById('maxAvail').value || 100);
            const minSales = Number(document.getElementById('minSales').value || 0);
            const abc = document.getElementById('abc').value;
            const xyz = document.getElementById('xyz').value;
            const q = (document.getElementById('q').value || '').trim().toLowerCase();
            const mode = document.getElementById('mode').value;

            const mapRow = mapRowFactory(data.headers);
            const mapped = data.rows.map(mapRow);

            shown = mapped.filter(r => {
                const hasAvail = Number.isFinite(r.Avail);
                const hasSales = Number.isFinite(r.Sales);
                const condAvail = hasAvail ? (r.Avail <= maxAvail) : false;
                const condSales = hasSales ? (r.Sales >= minSales) : false;

                let passes = false;
                if (mode === 'both') passes = condAvail && condSales;
                if (mode === 'either') passes = condAvail || condSales;
                if (mode === 'hylle') passes = condAvail;
                if (mode === 'salg') passes = condSales;

                const okABC = !abc || r.ABC === abc;
                const okXYZ = !xyz || r.XYZ === xyz;
                const okQ = !q || (r.Navn.toLowerCase().includes(q) || r.Kode.toLowerCase().includes(q));
                return passes && okABC && okXYZ && okQ;
            });

            const key = sortKey || 'Avail';
            shown.sort((a, b) => {
                const av = (a[key] ?? -Infinity), bv = (b[key] ?? -Infinity);
                if (av < bv) return -1 * sortDir;
                if (av > bv) return 1 * sortDir;
                if (a.Sales > b.Sales) return -1;
                if (a.Sales < b.Sales) return 1;
                return 0;
            });

            render();
        }

        /* ---------- Mapper UI ---------- */
        function populateMapper(headers, cols) {
            const ids = [['mapAvail', 'Hylle%'], ['mapSales', 'Salg verdi'], ['mapTurns', 'Lageromløp'], ['mapStock', 'Beholdningsverdi'], ['mapABC', 'ABC'], ['mapXYZ', 'XYZ']];
            ids.forEach(([id, key]) => {
                const sel = document.getElementById(id);
                sel.innerHTML = headers.map(h => `<option ${cols[key] === h ? 'selected' : ''}>${h}</option>`).join('');
            });
        }
        document.getElementById('saveMap').addEventListener('click', () => {
            manualMap = {
                'Hylle%': document.getElementById('mapAvail').value,
                'Salg verdi': document.getElementById('mapSales').value,
                'Lageromløp': document.getElementById('mapTurns').value,
                'Beholdningsverdi': document.getElementById('mapStock').value,
                'ABC': document.getElementById('mapABC').value,
                'XYZ': document.getElementById('mapXYZ').value,
            };
            localStorage.setItem('relexMap', JSON.stringify(manualMap));
            applyFilters();
        });

        /* ---------- Render ---------- */
        function render() {
            document.getElementById('kTotal').textContent = fmtNo(data.rows.length);
            document.getElementById('kShown').textContent = fmtNo(shown.length);
            const avg = shown.length ? (shown.reduce((s, r) => s + (r.Avail ?? 0), 0) / shown.length) : null;
            const sum = shown.length ? shown.reduce((s, r) => s + (r.Sales ?? 0), 0) : null;
            document.getElementById('kAvgA').textContent = avg == null ? '–' : avg.toFixed(2) + ' %';
            document.getElementById('kSumS').textContent = fmtKr(sum);

            const thead = document.querySelector('#tbl thead tr');
            const tbody = document.querySelector('#tbl tbody');
            thead.innerHTML = ''; tbody.innerHTML = '';

            const cols = [
                { h: 'Produkt', k: 'Navn' },
                { h: 'Kode', k: 'Kode' },
                { h: 'Hylle-servicegrad %', k: 'Avail' },
                { h: 'Salgsverdi', k: 'Sales' },
                { h: 'Lageromløp', k: 'Turns' },
                { h: 'Beholdningsverdi', k: 'StockVal' },
                { h: 'ABC', k: 'ABC' },
                { h: 'XYZ', k: 'XYZ' },
            ];
            for (const c of cols) {
                const th = document.createElement('th'); th.textContent = c.h; th.style.cursor = 'pointer';
                th.onclick = () => { sortKey = c.k; sortDir = (sortDir === 1 ? -1 : 1); applyFilters(); };
                thead.appendChild(th);
            }
            for (const r of shown) {
                const tr = document.createElement('tr');
                const sev = r.Avail == null ? null : (r.Avail < 90 ? 'bad' : r.Avail < 95 ? 'warn' : 'good');
                const sevTag = sev ? `<span class="tag ${sev}">${r.Avail.toFixed(2)} %</span>` : '<span class="muted">–</span>';
                tr.innerHTML = `
      <td>${r.Navn || '<span class="muted">–</span>'}</td>
      <td class="muted">${r.Kode || ''}</td>
      <td>${sevTag}</td>
      <td>${fmtKr(r.Sales)}</td>
      <td>${r.Turns == null ? '–' : r.Turns.toFixed(2)}</td>
      <td>${fmtKr(r.StockVal)}</td>
      <td>${r.ABC || '<span class="muted">–</span>'}</td>
      <td>${r.XYZ || '<span class="muted">–</span>'}</td>
    `;
                tbody.appendChild(tr);
            }

            document.getElementById('btnExport').disabled = shown.length === 0;
            document.getElementById('help').hidden = shown.length !== 0;
        }

        /* ---------- Export ---------- */
        function exportCSV() {
            const headers = ['Produkt', 'Kode', 'Hylle%', 'Salgsverdi', 'Lageromløp', 'Beholdningsverdi', 'ABC', 'XYZ'];
            const rows = shown.map(r => [
                r.Navn, r.Kode,
                r.Avail == null ? '' : r.Avail.toFixed(2),
                r.Sales == null ? '' : Math.round(r.Sales),
                r.Turns == null ? '' : r.Turns.toFixed(2),
                r.StockVal == null ? '' : Math.round(r.StockVal),
                r.ABC || '', r.XYZ || ''
            ]);
            const csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: 'relex-focus.csv' });
            a.click(); URL.revokeObjectURL(a.href);
        }

        /* ---------- Wiring ---------- */
        const drop = document.getElementById('drop'), file = document.getElementById('file');
        drop.addEventListener('click', () => file.click());
        drop.addEventListener('dragover', e => { e.preventDefault(); drop.style.borderColor = '#60a5fa'; });
        drop.addEventListener('dragleave', () => drop.style.borderColor = '');
        drop.addEventListener('drop', async e => { e.preventDefault(); drop.style.borderColor = ''; if (!e.dataTransfer.files.length) return; await load(e.dataTransfer.files[0]); });
        file.addEventListener('change', async () => { if (file.files.length) await load(file.files[0]); });
        for (const id of ['maxAvail', 'minSales', 'abc', 'xyz', 'q', 'mode']) {
            document.getElementById(id).addEventListener('input', applyFilters);
        }
        document.getElementById('btnExport').addEventListener('click', exportCSV);

        async function load(f) {
            drop.innerHTML = `<span class="pill">Lastet: ${f.name}</span>`;
            data = await readFile(f);
            applyFilters();
        }
    </script>
</body>

</html>